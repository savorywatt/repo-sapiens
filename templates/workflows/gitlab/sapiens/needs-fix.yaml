# @repo-sapiens-template
# @version: 1.0.0
# @name: needs-fix
#
# Triggered when 'sapiens/needs-fix' label is added.
# Reads review comments and creates fix proposal.
#
# Required CI/CD Variables:
#   - SAPIENS_GITLAB_TOKEN: GitLab API token with api scope
#   - SAPIENS_CLAUDE_API_KEY: Claude API key (if using claude-api agent)

stages:
  - fix

default:
  interruptible: true

create-fix-proposal:
  stage: fix
  image: python:3.12-slim
  timeout: 30 minutes
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /sapiens\/needs-fix/
    - if: $CI_PIPELINE_SOURCE == "trigger" && $SAPIENS_LABEL == "sapiens/needs-fix"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  variables:
    # Note: GITLAB_ prefix is reserved, so we source from SAPIENS_GITLAB_TOKEN
    GITLAB_TOKEN: $SAPIENS_GITLAB_TOKEN
    AUTOMATION__GIT_PROVIDER__BASE_URL: $CI_SERVER_URL
    AUTOMATION__GIT_PROVIDER__API_TOKEN: $SAPIENS_GITLAB_TOKEN
    AUTOMATION__REPOSITORY__OWNER: $CI_PROJECT_NAMESPACE
    AUTOMATION__REPOSITORY__NAME: $CI_PROJECT_NAME
    AUTOMATION__AGENT_PROVIDER__API_KEY: $SAPIENS_CLAUDE_API_KEY
  before_script:
    - pip install --quiet --no-cache-dir repo-sapiens
  script:
    - |
      MR_IID="${SAPIENS_ISSUE_NUMBER:-$CI_MERGE_REQUEST_IID}"
      echo "ðŸ”§ Creating fix proposal for MR !${MR_IID}"
      sapiens --config sapiens_config.ci.yaml process-issue \
        --issue "${MR_IID}" \
        --system-prompt .gitlab/workflows/sapiens/prompts/needs-fix.md
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        curl -sS -X POST \
          -H "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"body": "ðŸ”§ **Fix proposal created!**\n\nReview the proposed fixes and add `approved` label to apply them.\n\nâ—† Posted by Sapiens Automation"}' \
          "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      fi
  resource_group: sapiens-fix
