# @repo-sapiens-template
# @version: 1.0.0
# @name: requires-qa
#
# Triggered when 'sapiens/requires-qa' label is added.
# Generates test plan and verification steps.
#
# Required CI/CD Variables:
#   - SAPIENS_GITLAB_TOKEN: GitLab API token with api scope
#   - SAPIENS_CLAUDE_API_KEY: Claude API key (if using claude-api agent)

stages:
  - qa

default:
  interruptible: true

generate-qa-plan:
  stage: qa
  image: python:3.12-slim
  timeout: 30 minutes
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /sapiens\/requires-qa/
    - if: $CI_PIPELINE_SOURCE == "trigger" && $SAPIENS_LABEL == "sapiens/requires-qa"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  variables:
    # Note: GITLAB_ prefix is reserved, so we source from SAPIENS_GITLAB_TOKEN
    GITLAB_TOKEN: $SAPIENS_GITLAB_TOKEN
    AUTOMATION__GIT_PROVIDER__BASE_URL: $CI_SERVER_URL
    AUTOMATION__GIT_PROVIDER__API_TOKEN: $SAPIENS_GITLAB_TOKEN
    AUTOMATION__REPOSITORY__OWNER: $CI_PROJECT_NAMESPACE
    AUTOMATION__REPOSITORY__NAME: $CI_PROJECT_NAME
    AUTOMATION__AGENT_PROVIDER__API_KEY: $SAPIENS_CLAUDE_API_KEY
  before_script:
    - pip install --quiet --no-cache-dir repo-sapiens
  script:
    - |
      MR_IID="${SAPIENS_ISSUE_NUMBER:-$CI_MERGE_REQUEST_IID}"
      echo "ðŸ§ª Generating QA plan for MR !${MR_IID}"
      sapiens --config sapiens_config.ci.yaml process-issue \
        --issue "${MR_IID}" \
        --system-prompt .gitlab/workflows/sapiens/prompts/requires-qa.md
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        curl -sS -X POST \
          -H "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"body": "ðŸ§ª **QA plan generated!**\n\nSee test plan above.\n\nðŸ¤– Posted by Sapiens Automation"}' \
          "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      fi
  resource_group: sapiens-qa
