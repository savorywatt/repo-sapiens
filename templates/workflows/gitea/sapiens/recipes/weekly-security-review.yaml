# @repo-sapiens-template
# @version: 1.1.0
# @name: weekly-security-review
#
# Weekly Security Review for Gitea Actions
#
# Runs comprehensive security scans for configured languages, generates a report,
# and automatically fixes identified vulnerabilities where safe to do so.
#
# Supported Languages: Python, Go, Java, C++, C#, Kotlin, Clojure, Rust, TypeScript, JavaScript
#
# Setup:
# 1. Copy to .gitea/workflows/weekly-security-review.yaml
# 2. Set required secrets:
#    - SAPIENS_GITEA_TOKEN: Gitea API token with repo write access
#    - SAPIENS_CLAUDE_API_KEY: Claude API key  # pragma: allowlist secret
# 3. Configure SECURITY_LANGUAGES below with your project's languages
# 4. Adjust schedule as needed

name: Weekly Security Review

on:
  schedule:
    # Every Friday at 2pm UTC (before weekend, gives time to review)
    - cron: '0 14 * * 5'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Automatically fix vulnerabilities'
        required: false
        default: 'true'
      severity_threshold:
        description: 'Minimum severity to report (low, medium, high, critical)'
        required: false
        default: 'medium'

env:
  GITEA_TOKEN: ${{ secrets.SAPIENS_GITEA_TOKEN }}
  # Configure which languages to scan (space-separated)
  # Options: python go java cpp csharp kotlin clojure rust typescript javascript
  SECURITY_LANGUAGES: "{{SECURITY_LANGUAGES}}"

jobs:
  security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize security report
        run: |
          echo "# Security Review Report" > security-report.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M UTC')" >> security-report.md
          echo "Repository: ${{ github.repository }}" >> security-report.md
          echo "Languages: $SECURITY_LANGUAGES" >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # PYTHON SECURITY TOOLS
      # ============================================
      - name: Set up Python
        if: contains(env.SECURITY_LANGUAGES, 'python')
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python security tools
        if: contains(env.SECURITY_LANGUAGES, 'python')
        run: pip install bandit safety pip-audit

      - name: Run Bandit (Python security linter)
        if: contains(env.SECURITY_LANGUAGES, 'python')
        continue-on-error: true
        run: |
          echo "## Python Security (Bandit)" >> security-report.md
          echo '```' >> security-report.md

          if ls *.py &>/dev/null || [ -d "src" ] || [ -d "lib" ]; then
            bandit -r . -f json -o bandit-results.json --exclude .venv,venv,node_modules,dist,build 2>/dev/null || true

            if [ -f bandit-results.json ]; then
              python -c "
          import json
          try:
              data = json.load(open('bandit-results.json'))
              results = data.get('results', [])
              if results:
                  for r in results[:20]:
                      sev = r.get('issue_severity', 'UNKNOWN')
                      conf = r.get('issue_confidence', 'UNKNOWN')
                      text = r.get('issue_text', 'No description')
                      fname = r.get('filename', 'unknown')
                      line = r.get('line_number', 0)
                      print(f'[{sev}/{conf}] {fname}:{line}')
                      print(f'  {text}')
                      print()
                  if len(results) > 20:
                      print(f'... and {len(results) - 20} more issues')
              else:
                  print('No issues found!')
          except Exception as e:
              print(f'Error parsing results: {e}')
          "
            else
              echo "No Bandit results generated"
            fi
          else
            echo "No Python files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      - name: Run pip-audit (Python dependency vulnerabilities)
        if: contains(env.SECURITY_LANGUAGES, 'python')
        continue-on-error: true
        run: |
          echo "## Python Dependencies (pip-audit)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            pip-audit --format=json --output=pip-audit-results.json 2>/dev/null || true

            if [ -f pip-audit-results.json ] && [ -s pip-audit-results.json ]; then
              python -c "
          import json
          try:
              data = json.load(open('pip-audit-results.json'))
              if data:
                  for vuln in data[:15]:
                      name = vuln.get('name', 'unknown')
                      version = vuln.get('version', '?')
                      vuln_id = vuln.get('id', 'N/A')
                      fix = vuln.get('fix_versions', ['N/A'])
                      fix_ver = fix[0] if fix else 'N/A'
                      print(f'{name}=={version}: {vuln_id}')
                      print(f'  Fix available: {fix_ver}')
                      print()
                  if len(data) > 15:
                      print(f'... and {len(data) - 15} more vulnerabilities')
              else:
                  print('No vulnerabilities found!')
          except Exception as e:
              print(f'Error: {e}')
          "
            else
              echo "No vulnerabilities found or audit skipped"
            fi
          else
            echo "No Python dependency files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # GO SECURITY TOOLS
      # ============================================
      - name: Set up Go
        if: contains(env.SECURITY_LANGUAGES, 'go')
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Go security tools
        if: contains(env.SECURITY_LANGUAGES, 'go')
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run gosec (Go security linter)
        if: contains(env.SECURITY_LANGUAGES, 'go')
        continue-on-error: true
        run: |
          echo "## Go Security (gosec)" >> security-report.md
          echo '```' >> security-report.md

          if ls *.go &>/dev/null || [ -f "go.mod" ]; then
            gosec -fmt=json -out=gosec-results.json ./... 2>/dev/null || true

            if [ -f gosec-results.json ]; then
              python3 -c "
          import json
          try:
              data = json.load(open('gosec-results.json'))
              issues = data.get('Issues', [])
              if issues:
                  for r in issues[:15]:
                      sev = r.get('severity', 'UNKNOWN')
                      conf = r.get('confidence', 'UNKNOWN')
                      details = r.get('details', 'No description')
                      fname = r.get('file', 'unknown')
                      line = r.get('line', 0)
                      print(f'[{sev}/{conf}] {fname}:{line}')
                      print(f'  {details}')
                      print()
                  if len(issues) > 15:
                      print(f'... and {len(issues) - 15} more issues')
              else:
                  print('No issues found!')
          except Exception as e:
              print(f'Error: {e}')
          "
            else
              echo "No gosec results generated"
            fi
          else
            echo "No Go files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      - name: Run govulncheck (Go vulnerability scanner)
        if: contains(env.SECURITY_LANGUAGES, 'go')
        continue-on-error: true
        run: |
          echo "## Go Dependencies (govulncheck)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "go.mod" ]; then
            govulncheck -json ./... > govulncheck-results.json 2>/dev/null || true

            if [ -f govulncheck-results.json ] && [ -s govulncheck-results.json ]; then
              echo "Vulnerability scan complete - see govulncheck-results.json"
              grep -c '"osv":' govulncheck-results.json 2>/dev/null || echo "No vulnerabilities found"
            else
              echo "No vulnerabilities found"
            fi
          else
            echo "No go.mod found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # JAVA/KOTLIN SECURITY TOOLS
      # ============================================
      - name: Set up Java
        if: contains(env.SECURITY_LANGUAGES, 'java') || contains(env.SECURITY_LANGUAGES, 'kotlin')
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Run SpotBugs (Java security scanner)
        if: contains(env.SECURITY_LANGUAGES, 'java')
        continue-on-error: true
        run: |
          echo "## Java Security (SpotBugs)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            SPOTBUGS_VERSION="4.8.3"
            wget -q "https://github.com/spotbugs/spotbugs/releases/download/${SPOTBUGS_VERSION}/spotbugs-${SPOTBUGS_VERSION}.tgz"
            tar -xzf "spotbugs-${SPOTBUGS_VERSION}.tgz"

            if [ -d "target/classes" ] || [ -d "build/classes" ]; then
              CLASS_DIR=$([ -d "target/classes" ] && echo "target/classes" || echo "build/classes")
              ./spotbugs-${SPOTBUGS_VERSION}/bin/spotbugs -textui -xml:withMessages -output spotbugs-results.xml "$CLASS_DIR" 2>/dev/null || true

              if [ -f spotbugs-results.xml ]; then
                echo "SpotBugs scan complete - see spotbugs-results.xml"
                grep -c "<BugInstance" spotbugs-results.xml 2>/dev/null || echo "0 bugs found"
              else
                echo "No results generated"
              fi
            else
              echo "No compiled classes found. Build project first with: mvn compile or gradle build"
            fi
          else
            echo "No Java build file found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      - name: Run OWASP Dependency-Check (Java/Kotlin)
        if: contains(env.SECURITY_LANGUAGES, 'java') || contains(env.SECURITY_LANGUAGES, 'kotlin')
        continue-on-error: true
        run: |
          echo "## Java/Kotlin Dependencies (OWASP Dependency-Check)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            DC_VERSION="9.0.7"
            wget -q "https://github.com/jeremylong/DependencyCheck/releases/download/v${DC_VERSION}/dependency-check-${DC_VERSION}-release.zip"
            unzip -q "dependency-check-${DC_VERSION}-release.zip"

            ./dependency-check/bin/dependency-check.sh --scan . --format JSON --out dependency-check-results.json --nvdApiKey "" 2>/dev/null || true

            if [ -f dependency-check-results.json ]; then
              echo "OWASP Dependency-Check complete - see dependency-check-results.json"
            else
              echo "Scan completed (results may require NVD API key for full data)"
            fi
          else
            echo "No Java/Kotlin build file found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # RUST SECURITY TOOLS
      # ============================================
      - name: Set up Rust
        if: contains(env.SECURITY_LANGUAGES, 'rust')
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust security tools
        if: contains(env.SECURITY_LANGUAGES, 'rust')
        run: cargo install cargo-audit cargo-deny

      - name: Run cargo-audit (Rust vulnerability scanner)
        if: contains(env.SECURITY_LANGUAGES, 'rust')
        continue-on-error: true
        run: |
          echo "## Rust Security (cargo-audit)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "Cargo.toml" ]; then
            cargo audit --json > cargo-audit-results.json 2>/dev/null || true

            if [ -f cargo-audit-results.json ]; then
              python3 -c "
          import json
          try:
              data = json.load(open('cargo-audit-results.json'))
              vulns = data.get('vulnerabilities', {}).get('list', [])
              if vulns:
                  for v in vulns[:15]:
                      advisory = v.get('advisory', {})
                      pkg = v.get('package', {}).get('name', 'unknown')
                      version = v.get('package', {}).get('version', '?')
                      title = advisory.get('title', 'No title')
                      severity = advisory.get('severity', 'unknown')
                      print(f'[{severity.upper()}] {pkg}@{version}')
                      print(f'  {title}')
                      print()
                  if len(vulns) > 15:
                      print(f'... and {len(vulns) - 15} more vulnerabilities')
              else:
                  print('No vulnerabilities found!')
          except Exception as e:
              print(f'Error: {e}')
          "
            else
              echo "cargo-audit completed"
            fi
          else
            echo "No Cargo.toml found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      - name: Run cargo-deny (Rust license/advisory check)
        if: contains(env.SECURITY_LANGUAGES, 'rust')
        continue-on-error: true
        run: |
          echo "## Rust Dependencies (cargo-deny)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "Cargo.toml" ]; then
            cargo deny check 2>&1 | head -50 || echo "cargo-deny check completed"
          else
            echo "No Cargo.toml found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # C/C++ SECURITY TOOLS
      # ============================================
      - name: Install C/C++ security tools
        if: contains(env.SECURITY_LANGUAGES, 'cpp')
        run: sudo apt-get update && sudo apt-get install -y cppcheck flawfinder

      - name: Run cppcheck (C/C++ static analyzer)
        if: contains(env.SECURITY_LANGUAGES, 'cpp')
        continue-on-error: true
        run: |
          echo "## C/C++ Security (cppcheck)" >> security-report.md
          echo '```' >> security-report.md

          if ls *.c *.cpp *.cc *.cxx *.h *.hpp &>/dev/null 2>&1 || [ -d "src" ] || [ -d "include" ]; then
            cppcheck --enable=warning,security --xml --output-file=cppcheck-results.xml . 2>/dev/null || true

            if [ -f cppcheck-results.xml ]; then
              grep -c "<error" cppcheck-results.xml 2>/dev/null || echo "0 issues found"
              echo "See cppcheck-results.xml for details"
            else
              echo "cppcheck completed"
            fi
          else
            echo "No C/C++ files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      - name: Run flawfinder (C/C++ vulnerability scanner)
        if: contains(env.SECURITY_LANGUAGES, 'cpp')
        continue-on-error: true
        run: |
          echo "## C/C++ Vulnerabilities (flawfinder)" >> security-report.md
          echo '```' >> security-report.md

          if ls *.c *.cpp *.cc *.cxx *.h *.hpp &>/dev/null 2>&1 || [ -d "src" ] || [ -d "include" ]; then
            flawfinder --html . > flawfinder-results.html 2>/dev/null || true
            flawfinder --minlevel=2 . 2>/dev/null | head -30 || echo "No significant issues found"
          else
            echo "No C/C++ files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # C# SECURITY TOOLS
      # ============================================
      - name: Set up .NET
        if: contains(env.SECURITY_LANGUAGES, 'csharp')
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Run dotnet security audit (C#)
        if: contains(env.SECURITY_LANGUAGES, 'csharp')
        continue-on-error: true
        run: |
          echo "## C# Dependencies (dotnet list package)" >> security-report.md
          echo '```' >> security-report.md

          if ls *.csproj *.sln &>/dev/null 2>&1; then
            dotnet list package --vulnerable --include-transitive 2>/dev/null || echo "No vulnerable packages found"
          else
            echo "No .NET project files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # CLOJURE SECURITY TOOLS
      # ============================================
      - name: Set up Clojure
        if: contains(env.SECURITY_LANGUAGES, 'clojure')
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: latest

      - name: Run nvd-clojure (Clojure vulnerability scanner)
        if: contains(env.SECURITY_LANGUAGES, 'clojure')
        continue-on-error: true
        run: |
          echo "## Clojure Dependencies (nvd-clojure)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "deps.edn" ] || [ -f "project.clj" ]; then
            echo "For nvd-clojure, add to deps.edn:"
            echo '  :aliases {:nvd {:extra-deps {nvd-clojure/nvd-clojure {:mvn/version "4.0.0"}}'
            echo '                  :main-opts ["-m" "nvd.task.check"]}}'
            echo ""
            echo "Then run: clj -M:nvd"

            if grep -q "nvd-clojure" deps.edn 2>/dev/null; then
              clojure -M:nvd 2>/dev/null || echo "nvd-clojure check completed"
            fi
          else
            echo "No Clojure project files found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # TYPESCRIPT/JAVASCRIPT SECURITY TOOLS
      # ============================================
      - name: Set up Node.js
        if: contains(env.SECURITY_LANGUAGES, 'typescript') || contains(env.SECURITY_LANGUAGES, 'javascript')
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit (JS/TS dependency scanner)
        if: contains(env.SECURITY_LANGUAGES, 'typescript') || contains(env.SECURITY_LANGUAGES, 'javascript')
        continue-on-error: true
        run: |
          echo "## JavaScript/TypeScript Dependencies (npm audit)" >> security-report.md
          echo '```' >> security-report.md

          if [ -f "package.json" ]; then
            npm audit --json > npm-audit-results.json 2>/dev/null || true

            if [ -f npm-audit-results.json ]; then
              python3 -c "
          import json
          try:
              data = json.load(open('npm-audit-results.json'))
              vulns = data.get('vulnerabilities', {})
              if vulns:
                  count = 0
                  for name, info in list(vulns.items())[:15]:
                      severity = info.get('severity', 'unknown')
                      via = info.get('via', [])
                      title = via[0].get('title', 'No title') if isinstance(via, list) and via and isinstance(via[0], dict) else str(via)[:50]
                      print(f'[{severity.upper()}] {name}')
                      print(f'  {title}')
                      print()
                      count += 1
                  if len(vulns) > 15:
                      print(f'... and {len(vulns) - 15} more vulnerabilities')
              else:
                  print('No vulnerabilities found!')
          except Exception as e:
              print(f'Error: {e}')
          "
            else
              echo "npm audit completed"
            fi
          else
            echo "No package.json found"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # MULTI-LANGUAGE: OPENGREP (supports many languages)
      # ============================================
      - name: Install OpenGrep
        run: |
          curl -fsSL https://raw.githubusercontent.com/opengrep/opengrep/main/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run OpenGrep (multi-language SAST)
        continue-on-error: true
        run: |
          echo "## Static Analysis (OpenGrep)" >> security-report.md
          echo '```' >> security-report.md

          # Clone community rules for security scanning
          git clone --depth 1 https://github.com/semgrep/semgrep-rules.git /tmp/semgrep-rules 2>/dev/null || true

          # Run opengrep with security-focused rules
          if [ -d "/tmp/semgrep-rules" ]; then
            opengrep scan \
              --sarif-output=opengrep-results.sarif \
              -f /tmp/semgrep-rules/python/security \
              -f /tmp/semgrep-rules/javascript/security \
              -f /tmp/semgrep-rules/typescript/security \
              -f /tmp/semgrep-rules/go/security \
              -f /tmp/semgrep-rules/java/security \
              -f /tmp/semgrep-rules/ruby/security \
              -f /tmp/semgrep-rules/generic/security \
              . 2>/dev/null || true
          fi

          if [ -f opengrep-results.sarif ]; then
            python3 -c "
          import json
          try:
              data = json.load(open('opengrep-results.sarif'))
              runs = data.get('runs', [])
              results = []
              for run in runs:
                  results.extend(run.get('results', []))
              if results:
                  for r in results[:15]:
                      rule = r.get('ruleId', 'unknown')
                      msg = r.get('message', {}).get('text', 'No message')[:100]
                      locations = r.get('locations', [{}])
                      loc = locations[0].get('physicalLocation', {}) if locations else {}
                      path = loc.get('artifactLocation', {}).get('uri', 'unknown')
                      line = loc.get('region', {}).get('startLine', 0)
                      level = r.get('level', 'note')
                      print(f'[{level.upper()}] {rule}')
                      print(f'  {path}:{line}')
                      print(f'  {msg}')
                      print()
                  if len(results) > 15:
                      print(f'... and {len(results) - 15} more findings')
              else:
                  print('No issues found!')
          except Exception as e:
              print(f'Error: {e}')
          "
          else
            echo "OpenGrep scan completed (no results file)"
          fi

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # SECRETS DETECTION (all languages)
      # ============================================
      - name: Check for secrets in code
        continue-on-error: true
        run: |
          echo "## Secrets Detection" >> security-report.md
          echo '```' >> security-report.md

          python3 -c "
          import os
          import re

          patterns = [
              (r'(?i)(api[_-]?key|apikey)\s*[=:]\s*['\"]?[a-zA-Z0-9_-]{20,}', 'API Key'),
              (r'(?i)(secret|password|passwd|pwd)\s*[=:]\s*['\"]?[^\s'\",]{8,}', 'Secret/Password'),
              (r'(?i)bearer\s+[a-zA-Z0-9_-]{20,}', 'Bearer Token'),
              (r'ghp_[a-zA-Z0-9]{36}', 'GitHub Token'),
              (r'sk-[a-zA-Z0-9]{48}', 'OpenAI Key'),
              (r'AKIA[0-9A-Z]{16}', 'AWS Access Key'),
          ]

          findings = []
          skip_dirs = {'.git', 'node_modules', '.venv', 'venv', '__pycache__', 'dist', 'build', 'target'}
          skip_ext = {'.pyc', '.so', '.dll', '.exe', '.bin', '.png', '.jpg', '.gif', '.ico', '.jar', '.class'}

          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if d not in skip_dirs]
              for fname in files:
                  if any(fname.endswith(ext) for ext in skip_ext):
                      continue
                  fpath = os.path.join(root, fname)
                  try:
                      with open(fpath, 'r', errors='ignore') as f:
                          content = f.read()
                          for pattern, desc in patterns:
                              if re.search(pattern, content):
                                  findings.append((fpath, desc))
                                  break
                  except:
                      pass

          if findings:
              print('Potential secrets found:')
              for path, desc in findings[:10]:
                  print(f'  [{desc}] {path}')
              if len(findings) > 10:
                  print(f'  ... and {len(findings) - 10} more')
          else:
              print('No hardcoded secrets detected')
          "

          echo '```' >> security-report.md
          echo "" >> security-report.md

      # ============================================
      # SUMMARY AND REPORTING
      # ============================================
      - name: Generate summary
        run: |
          echo "## Summary" >> security-report.md
          echo "" >> security-report.md
          echo "| Scanner | Issues Found |" >> security-report.md
          echo "|---------|--------------|" >> security-report.md

          TOTAL=0

          if [ -f bandit-results.json ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('bandit-results.json')); print(len(d.get('results', [])))" 2>/dev/null || echo 0)
            echo "| Bandit (Python) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          if [ -f pip-audit-results.json ] && [ -s pip-audit-results.json ]; then
            COUNT=$(python3 -c "import json; print(len(json.load(open('pip-audit-results.json'))))" 2>/dev/null || echo 0)
            echo "| pip-audit (Python deps) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          if [ -f gosec-results.json ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('gosec-results.json')); print(len(d.get('Issues', [])))" 2>/dev/null || echo 0)
            echo "| gosec (Go) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          if [ -f cargo-audit-results.json ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('cargo-audit-results.json')); print(len(d.get('vulnerabilities',{}).get('list',[])))" 2>/dev/null || echo 0)
            echo "| cargo-audit (Rust) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          if [ -f npm-audit-results.json ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('npm-audit-results.json')); print(len(d.get('vulnerabilities',{})))" 2>/dev/null || echo 0)
            echo "| npm audit (JS/TS) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          if [ -f opengrep-results.sarif ]; then
            COUNT=$(python3 -c "import json; d=json.load(open('opengrep-results.sarif')); print(sum(len(r.get('results',[])) for r in d.get('runs',[])))" 2>/dev/null || echo 0)
            echo "| OpenGrep (SAST) | $COUNT |" >> security-report.md
            TOTAL=$((TOTAL + COUNT))
          fi

          echo "" >> security-report.md
          echo "**Total issues: $TOTAL**" >> security-report.md

          echo "TOTAL_ISSUES=$TOTAL" >> $GITHUB_ENV

      - name: Create fix branch
        if: env.TOTAL_ISSUES != '0'
        run: |
          git config user.name "gitea-actions[bot]"
          git config user.email "gitea-actions[bot]@users.noreply.github.com"
          BRANCH="auto/security-fixes-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Auto-fix security issues
        if: env.TOTAL_ISSUES != '0' && (github.event.inputs.auto_fix != 'false')
        env:
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.SAPIENS_CLAUDE_API_KEY }}
          SAPIENS_REPO_URL: ${{ secrets.SAPIENS_REPO_URL }}
          SAPIENS_BRANCH: ${{ secrets.SAPIENS_BRANCH }}
        run: |
          if [ -n "$SAPIENS_REPO_URL" ]; then
            echo "Installing repo-sapiens from $SAPIENS_REPO_URL (branch: ${SAPIENS_BRANCH:-main})"
            git clone "$SAPIENS_REPO_URL" /tmp/repo-sapiens
            cd /tmp/repo-sapiens
            git checkout "${SAPIENS_BRANCH:-main}"
            pip install -e .
            cd -
          else
            pip install repo-sapiens || pip3 install repo-sapiens
          fi

          sapiens task "Review the security report and fix identified vulnerabilities.

          $(cat security-report.md)

          Raw scan results are available in JSON files (check which exist):
          - bandit-results.json (Python security issues)
          - pip-audit-results.json (Python dependency vulnerabilities)
          - gosec-results.json (Go security issues)
          - govulncheck-results.json (Go dependency vulnerabilities)
          - cargo-audit-results.json (Rust vulnerabilities)
          - npm-audit-results.json (JS/TS dependency vulnerabilities)
          - opengrep-results.sarif (static analysis findings)

          Tasks:
          1. Review each security finding in the report
          2. For dependency vulnerabilities:
             - Update vulnerable packages to fixed versions
             - Only update to versions that fix the vulnerability
          3. For code vulnerabilities:
             - Fix SQL injection by using parameterized queries
             - Fix command injection by using subprocess with lists (Python) or exec.Command (Go)
             - Fix path traversal by validating/sanitizing paths
             - Fix hardcoded secrets by using environment variables
             - Fix insecure deserialization by using safe alternatives
          4. Run tests after fixes if test command is available
          5. Skip fixes that:
             - Are false positives (explain why in commit message)
             - Would require significant refactoring
             - Are in third-party or generated code

          Guidelines:
          - Be conservative - only fix clear vulnerabilities
          - Don't break functionality to fix security issues
          - Add comments explaining security fixes where helpful
          - Group related fixes in logical commits

          Commit format: 'security: Fix [vulnerability type] in [file/module]'"

      - name: Create Pull Request
        if: env.TOTAL_ISSUES != '0'
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No security fixes made"
            exit 0
          fi

          git commit -m "security: Weekly security fixes

          Automated fixes for vulnerabilities identified by security scanners.

          See PR description for full security report." || true

          git push -u origin "$BRANCH" || true

          curl -X POST \
            -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/json" \
            "${{ github.server_url }}/api/v1/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"security: Weekly security fixes ($(date +%Y-%m-%d))\",
              \"body\": \"## Security Review Report\n\n$(cat security-report.md | jq -Rs . | sed 's/^\"//;s/\"$//')\n\n---\nGenerated by repo-sapiens weekly security review workflow.\",
              \"head\": \"$BRANCH\",
              \"base\": \"main\"
            }" || echo "PR creation failed - may need manual creation"

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            security-report.md
            *-results.json
            *-results.xml
            *-results.html
          retention-days: 30
