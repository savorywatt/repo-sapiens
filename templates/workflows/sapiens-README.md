# Sapiens Workflows

This directory contains workflows managed by [repo-sapiens](https://github.com/savorywatt/repo-sapiens) for automated issue processing and task management.

## How It Works

These workflows are triggered by **issue labels**. When you add a specific label to an issue, the corresponding workflow automatically processes it.

## Workflow Triggers

### Core Workflows

| Workflow | Label | Description |
|----------|-------|-------------|
| `needs-planning.yaml` | `needs-planning` | Creates a development plan from an issue description |
| `approved.yaml` | `approved` | Converts an approved plan into executable tasks |
| `execute-task.yaml` | `execute-task` | Implements code for a task issue |
| `needs-review.yaml` | `needs-review` | Performs automated code review on a PR |
| `requires-qa.yaml` | `requires-qa` | Runs QA validation and testing |
| `needs-fix.yaml` | `needs-fix` | Fixes issues identified during review/QA |

### Automation Workflows

| Workflow | Trigger | Description |
|----------|---------|-------------|
| `automation-daemon.yaml` | Schedule (every 5 min) | Periodic processor for pending issues |
| `process-issue.yaml` | Manual dispatch | Process a single issue on-demand |

## Quick Start

### 1. Create an Issue

Create a new issue describing what you want to build:

```
Title: Add user authentication feature

Description:
We need to add user authentication to the application.
Users should be able to sign up, log in, and log out.
Use JWT tokens for session management.
```

### 2. Add a Label

Add the `needs-planning` label to trigger the planning workflow.

### 3. Review the Plan

The workflow will:
- Analyze your requirements
- Research the codebase
- Generate a detailed implementation plan
- Post the plan as a comment on the issue

### 4. Approve the Plan

Review the generated plan. If it looks good:
- Add the `approved` label to create executable tasks

### 5. Execute Tasks

For each task created:
- Add the `execute-task` label to trigger implementation
- The workflow will write the code and create a PR

### 6. Review & QA

- Add `needs-review` for automated code review
- Add `requires-qa` for testing and validation
- Add `needs-fix` if issues are found

## Label Workflow

```
Issue Creation
    ↓
Add: needs-planning
    ↓
Plan Generated
    ↓
Add: approved
    ↓
Tasks Created
    ↓
Add: execute-task (on each task)
    ↓
PR Created
    ↓
Add: needs-review (on PR)
    ↓
Review Complete
    ↓
Add: requires-qa (on PR)
    ↓
QA Complete
    ↓
Add: needs-fix (if issues found)
    ↓
Merge!
```

## Configuration

### Required Secrets

Configure these secrets in your repository settings:

| Secret | Description |
|--------|-------------|
| `SAPIENS_GITEA_TOKEN` | Gitea API token with repo/issue access |
| `SAPIENS_CLAUDE_API_KEY` | Anthropic Claude API key |
| `SAPIENS_GITHUB_TOKEN` | GitHub token (if using GitHub) |

### Config File

Each workflow uses the config file at `.sapiens/config.yaml` in your repository.

You can customize:
- AI agent provider (Claude, Goose, Ollama)
- Workflow behavior
- Automation settings

Run `sapiens init` to create or update your config.

## Customization

### Modify Schedules

Edit `automation-daemon.yaml` to change processing frequency:

```yaml
on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
```

### Add Custom Labels

Create new workflow files following the pattern:

```yaml
name: My Custom Workflow
on:
  issues:
    types: [labeled]
jobs:
  process:
    if: gitea.event.label.name == 'my-custom-label'
    # ... your steps
```

## Troubleshooting

### Workflow Not Triggering

- Verify the label name matches exactly (case-sensitive)
- Check that Gitea Actions is enabled
- Ensure a runner is active and online
- Check workflow logs in Actions tab

### Permission Errors

- Verify `SAPIENS_GITEA_TOKEN` has correct permissions
- Token needs: `repo`, `read:org`, `write:issue`

### AI Errors

- Check `SAPIENS_CLAUDE_API_KEY` is set correctly
- Verify API quota/limits
- Check workflow logs for specific error messages

## Recipe Workflows

The `recipes/` subdirectory contains additional example workflows for:
- Daily issue triage
- Weekly test coverage reports
- Security scans
- Dependency audits
- And more...

These are optional and can be customized for your project.

## Learn More

- **Documentation**: https://github.com/savorywatt/repo-sapiens#readme
- **Getting Started**: See `docs/GETTING_STARTED.md`
- **Full Guide**: See `docs/DEPLOYMENT_GUIDE.md`

---

*These workflows were generated by repo-sapiens. To update them, run `sapiens update`.*
