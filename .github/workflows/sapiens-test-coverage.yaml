# .github/workflows/sapiens-test-coverage.yaml
# Reusable workflow for test coverage improvement
name: "Sapiens Test Coverage"

on:
  workflow_call:
    inputs:
      coverage_threshold:
        description: 'Minimum coverage percentage to target'
        required: false
        type: number
        default: 60
      test_command:
        description: 'Custom test command (default: pytest)'
        required: false
        type: string
        default: 'python -m pytest tests/ --cov --cov-report=json --cov-report=term -q'
    secrets:
      GIT_TOKEN:
        description: 'GitHub token for API access'
        required: true
      AI_API_KEY:
        description: 'AI provider API key for analysis'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  improve-coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install git+https://github.com/savorywatt/repo-sapiens.git@v2
          pip install -e ".[dev]" 2>/dev/null || pip install -e . pytest pytest-cov

      - name: Run coverage analysis
        id: coverage
        run: |
          # Run tests with coverage
          ${{ inputs.test_command }} || true

          # Extract coverage summary
          if [ -f coverage.json ]; then
            TOTAL=$(python -c "import json; d=json.load(open('coverage.json')); print(d['totals']['percent_covered'])")
            echo "total_coverage=$TOTAL" >> $GITHUB_OUTPUT
            echo "Current coverage: $TOTAL%"
          else
            echo "total_coverage=0" >> $GITHUB_OUTPUT
            echo "No coverage data found"
          fi

      - name: Create test improvement branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="auto/improve-coverage-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Check AI API key
        id: check-ai
        env:
          AI_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          if [ -n "$AI_KEY" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::notice::AI_API_KEY not provided - skipping AI-powered coverage improvement"
          fi

      - name: Improve test coverage
        if: steps.check-ai.outputs.has_key == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          TARGET=${{ inputs.coverage_threshold }}

          sapiens task "Improve test coverage for this Python project.

          Current total coverage: ${{ steps.coverage.outputs.total_coverage }}%
          Target coverage: ${TARGET}%

          Tasks:
          1. Read coverage.json to identify files with lowest coverage
          2. Pick ONE module with coverage below ${TARGET}% to improve
          3. Read the source file to understand what needs testing
          4. Write comprehensive unit tests for uncovered code paths
          5. Run the tests to verify they pass: python -m pytest tests/ -v

          Guidelines:
          - Focus on one module at a time for reviewable PRs
          - Write meaningful tests, not just coverage padding
          - Include edge cases and error conditions
          - Follow existing test patterns in the codebase

          Commit your changes with message: 'test: Add tests for [module name]'"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No test changes made"
            exit 0
          fi

          git commit -m "test: Improve test coverage" || true
          git push -u origin "$BRANCH" || true

          gh pr create \
            --title "test: Improve test coverage" \
            --body "## Summary
          Automated PR to improve test coverage.

          Current coverage: ${{ steps.coverage.outputs.total_coverage }}%
          Target coverage: ${{ inputs.coverage_threshold }}%

          ---
          Generated by repo-sapiens test coverage workflow." \
            --base main \
            --head "$BRANCH" || echo "PR creation failed or already exists"

      - name: Add to job summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "Current coverage: ${{ steps.coverage.outputs.total_coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "Target coverage: ${{ inputs.coverage_threshold }}%" >> $GITHUB_STEP_SUMMARY
