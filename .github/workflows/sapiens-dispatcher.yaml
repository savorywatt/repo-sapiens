# .github/workflows/sapiens-dispatcher.yaml
name: "Sapiens Dispatcher"

on:
  workflow_call:
    inputs:
      label:
        description: 'Label that triggered the workflow'
        required: true
        type: string
      issue_number:
        description: 'Issue or PR number'
        required: true
        type: string
      event_type:
        description: 'Event type for sapiens CLI (e.g., issues.labeled, pull_request.labeled)'
        required: false
        type: string
        default: 'issues.labeled'
      # Git provider options (for Gitea compatibility)
      git_provider_type:
        description: 'Git provider (github, gitea)'
        required: false
        type: string
        default: 'github'
      git_provider_url:
        description: 'Git provider API URL'
        required: false
        type: string
        default: 'https://api.github.com'
      # AI provider options
      # Valid types: openai-compatible, ollama, claude-local (requires Claude CLI)
      ai_provider_type:
        description: 'AI provider type (openai-compatible, ollama, claude-local)'
        required: false
        type: string
        default: 'openai-compatible'
      ai_model:
        description: 'AI model to use'
        required: false
        type: string
        default: ''
      ai_base_url:
        description: 'AI provider base URL (for openai-compatible/ollama)'
        required: false
        type: string
        default: ''
    secrets:
      GIT_TOKEN:
        description: 'GitHub or Gitea token for API access'
        required: true
      AI_API_KEY:
        description: 'AI provider API key (not required for ollama)'
        required: false

# Permissions required for the workflow
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process:
    name: "Sapiens: ${{ inputs.label }}"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # No label filter here - let sapiens process-label handle routing
    # This allows custom label configurations to work

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use GIT_TOKEN if provided, otherwise fall back to default GITHUB_TOKEN
          # GIT_TOKEN is needed for cross-repo reusable workflows
          token: ${{ secrets.GIT_TOKEN || github.token }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # Note: No pip caching - target repos may not have requirements.txt/pyproject.toml

      - name: Install sapiens
        run: pip install git+https://github.com/savorywatt/repo-sapiens.git@v2

      - name: Configure git
        if: contains(fromJSON('["execute", "approved"]'), inputs.label)
        run: |
          git config --global user.name "Sapiens Bot"
          git config --global user.email "sapiens-bot@users.noreply.github.com"

      - name: Generate sapiens config
        env:
          GIT_PROVIDER_TYPE: ${{ inputs.git_provider_type }}
          GIT_PROVIDER_URL: ${{ inputs.git_provider_url }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          AI_PROVIDER_TYPE: ${{ inputs.ai_provider_type }}
          AI_MODEL: ${{ inputs.ai_model }}
          AI_BASE_URL: ${{ inputs.ai_base_url }}
        run: |
          # Use existing config if present, otherwise generate minimal config
          if [ -f ".sapiens/config.yaml" ]; then
            echo "Using existing .sapiens/config.yaml"
          else
            echo "Generating minimal sapiens config..."
            mkdir -p .sapiens
            printf 'git_provider:\n  provider_type: "%s"\n  base_url: "%s"\n  api_token: "@env:AUTOMATION__GIT_PROVIDER__API_TOKEN"\n\nrepository:\n  owner: "%s"\n  name: "%s"\n\nagent_provider:\n  provider_type: "%s"\n  model: "%s"\n  api_key: "@env:AUTOMATION__AGENT_PROVIDER__API_KEY"\n  base_url: "%s"\n' "$GIT_PROVIDER_TYPE" "$GIT_PROVIDER_URL" "$REPO_OWNER" "$REPO_NAME" "$AI_PROVIDER_TYPE" "${AI_MODEL:-claude-sonnet-4.5}" "${AI_BASE_URL:-http://localhost:11434}" > .sapiens/config.yaml
            echo "Config generated:"
            cat .sapiens/config.yaml
          fi

      - name: Process label
        env:
          AUTOMATION__GIT_PROVIDER__PROVIDER_TYPE: ${{ inputs.git_provider_type }}
          AUTOMATION__GIT_PROVIDER__BASE_URL: ${{ inputs.git_provider_url }}
          # Use GIT_TOKEN if provided, otherwise fall back to github.token
          AUTOMATION__GIT_PROVIDER__API_TOKEN: ${{ secrets.GIT_TOKEN || github.token }}
          AUTOMATION__REPOSITORY__OWNER: ${{ github.repository_owner }}
          AUTOMATION__REPOSITORY__NAME: ${{ github.event.repository.name }}
          AUTOMATION__AGENT_PROVIDER__PROVIDER_TYPE: ${{ inputs.ai_provider_type }}
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.AI_API_KEY }}
          AUTOMATION__AGENT_PROVIDER__MODEL: ${{ inputs.ai_model }}
          AUTOMATION__AGENT_PROVIDER__BASE_URL: ${{ inputs.ai_base_url }}
        run: |
          echo "Processing label '${{ inputs.label }}' on #${{ inputs.issue_number }}"
          echo "   Provider: ${{ inputs.git_provider_type }}"
          echo "   AI: ${{ inputs.ai_provider_type }}"
          sapiens process-label \
            --event-type "${{ inputs.event_type }}" \
            --label "${{ inputs.label }}" \
            --issue "${{ inputs.issue_number }}" \
            --source "${{ inputs.git_provider_type }}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sapiens-${{ inputs.label }}-${{ inputs.issue_number }}
          path: .sapiens/
          retention-days: 7
          if-no-files-found: ignore

      # Use gh CLI for failure comments on GitHub
      - name: Post failure comment (GitHub)
        if: failure() && inputs.git_provider_type == 'github'
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN || github.token }}
        run: |
          gh issue comment ${{ inputs.issue_number }} \
            --body "**Sapiens automation failed**

          Label: \`${{ inputs.label }}\`
          Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          Posted by Sapiens Automation"

      # Use curl for failure comments on Gitea
      - name: Post failure comment (Gitea)
        if: failure() && inputs.git_provider_type == 'gitea'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GIT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"body": "**Sapiens automation failed**\n\nLabel: `${{ inputs.label }}`\nCheck the workflow logs for details.\n\nPosted by Sapiens Automation"}' \
            "${{ inputs.git_provider_url }}/api/v1/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/issues/${{ inputs.issue_number }}/comments"
