# .github/workflows/sapiens-dependency-audit.yaml
# Reusable workflow for dependency auditing and updates
name: "Sapiens Dependency Audit"

on:
  workflow_call:
    inputs:
      fail_on_critical:
        description: 'Fail if critical vulnerabilities are found'
        required: false
        type: boolean
        default: false
      ignore_dev:
        description: 'Ignore development dependencies'
        required: false
        type: boolean
        default: false
    secrets:
      GIT_TOKEN:
        description: 'GitHub token for API access'
        required: true
      AI_API_KEY:
        description: 'AI provider API key for analysis'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  audit-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install tools
        run: |
          pip install repo-sapiens==0.5.1 pip-audit safety

      - name: Check for outdated packages
        id: outdated
        continue-on-error: true
        run: |
          echo "## Outdated Packages" > dependency-report.md
          pip list --outdated --format=json > outdated.json 2>/dev/null || echo "[]" > outdated.json
          python -c "
          import json
          data = json.load(open('outdated.json'))
          if data:
              print('| Package | Current | Latest |')
              print('|---------|---------|--------|')
              for p in data[:20]:
                  print(f\"| {p['name']} | {p['version']} | {p['latest_version']} |\")
          else:
              print('All packages are up to date!')
          " >> dependency-report.md

      - name: Security audit
        id: security
        continue-on-error: true
        run: |
          echo -e "\n## Security Vulnerabilities" >> dependency-report.md

          # Try pip-audit first
          pip-audit --format=json > audit.json 2>/dev/null || echo "[]" > audit.json

          python -c "
          import json
          try:
              data = json.load(open('audit.json'))
              if data:
                  print('| Package | Vulnerability | Fix Version |')
                  print('|---------|---------------|-------------|')
                  for v in data[:10]:
                      print(f\"| {v.get('name', 'unknown')} | {v.get('id', 'N/A')} | {v.get('fix_versions', ['N/A'])[0] if v.get('fix_versions') else 'N/A'} |\")
              else:
                  print('No known vulnerabilities found!')
          except:
              print('Security audit completed - check logs for details')
          " >> dependency-report.md

      - name: Create update branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="auto/dependency-audit-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Check AI API key
        id: check-ai
        env:
          AI_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          if [ -n "$AI_KEY" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::notice::AI_API_KEY not provided - skipping AI-powered dependency analysis"
          fi

      - name: Analyze and update dependencies
        if: steps.check-ai.outputs.has_key == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          AUTOMATION__GIT_PROVIDER__API_TOKEN: ${{ secrets.GIT_TOKEN }}
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          sapiens task "Review the dependency audit report and update safe dependencies.

          $(cat dependency-report.md)

          Tasks:
          1. Review outdated.json for packages that can be safely updated
          2. Prioritize security fixes from audit.json
          3. For PATCH and MINOR updates of well-known packages, update them
          4. For MAJOR updates, only update if there are security issues
          5. Update pyproject.toml or requirements.txt with new versions
          6. Run tests to verify nothing breaks: python -m pytest tests/ -x

          Guidelines:
          - Be conservative - only update what's safe
          - Skip updates that break tests
          - Group related updates together
          - Note any packages that need manual review

          Commit changes with: 'chore(deps): Update dependencies [audit]'"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No dependency changes made"
            exit 0
          fi

          git commit -m "chore(deps): Dependency audit updates" || true
          git push -u origin "$BRANCH" || true

          gh pr create \
            --title "chore(deps): Dependency audit updates" \
            --body "## Dependency Audit Report

          $(cat dependency-report.md)

          ---
          Generated by repo-sapiens dependency audit workflow." \
            --base main \
            --head "$BRANCH" || echo "PR creation failed or already exists"

      - name: Fail on critical vulnerabilities
        if: inputs.fail_on_critical
        run: |
          CRITICAL=$(python -c "
          import json
          data = json.load(open('audit.json'))
          critical = [v for v in data if 'critical' in str(v).lower()]
          print(len(critical))
          " 2>/dev/null || echo 0)

          if [ "$CRITICAL" != "0" ]; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi

      - name: Add to job summary
        run: cat dependency-report.md >> $GITHUB_STEP_SUMMARY
