# .github/workflows/sapiens-sbom-license.yaml
# Reusable workflow for SBOM generation and license compliance
name: "Sapiens SBOM & License"

on:
  workflow_call:
    inputs:
      project_license:
        description: 'Project license for compatibility checking (e.g., MIT, Apache-2.0)'
        required: false
        type: string
        default: 'MIT'
      deny_licenses:
        description: 'Comma-separated list of denied licenses (e.g., GPL-3.0,AGPL-3.0)'
        required: false
        type: string
        default: ''
      create_issues:
        description: 'Create issues for problems found'
        required: false
        type: boolean
        default: true
      fail_on_vulnerabilities:
        description: 'Fail on high/critical vulnerabilities'
        required: false
        type: boolean
        default: false
    secrets:
      GIT_TOKEN:
        description: 'GitHub token for API access'
        required: true
      AI_API_KEY:
        description: 'AI provider API key for analysis'
        required: false

permissions:
  contents: write
  issues: write

jobs:
  sbom-and-license:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}

      - name: Install Syft (SBOM generator)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Grype (vulnerability scanner)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM (CycloneDX format)
        run: |
          echo "Generating Software Bill of Materials..."
          syft dir:. -o cyclonedx-json=sbom.cyclonedx.json -o spdx-json=sbom.spdx.json -o json=sbom.syft.json

          echo "SBOM generated successfully"

          # Count components
          COMPONENT_COUNT=$(python3 -c "
          import json
          data = json.load(open('sbom.cyclonedx.json'))
          components = data.get('components', [])
          print(len(components))
          ")
          echo "Total components: $COMPONENT_COUNT"
          echo "COMPONENT_COUNT=$COMPONENT_COUNT" >> $GITHUB_ENV

      - name: Scan for vulnerabilities with Grype
        run: |
          echo "Scanning SBOM for known vulnerabilities..."
          grype sbom:sbom.cyclonedx.json -o json > grype-results.json 2>/dev/null || true

          # Parse results
          python3 << 'EOF'
          import json
          import os

          try:
              data = json.load(open('grype-results.json'))
              matches = data.get('matches', [])

              # Count by severity
              severity_counts = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0, 'Negligible': 0}
              for m in matches:
                  vuln = m.get('vulnerability', {})
                  sev = vuln.get('severity', 'Unknown')
                  if sev in severity_counts:
                      severity_counts[sev] += 1

              print(f"Vulnerabilities found: {len(matches)}")
              for sev, count in severity_counts.items():
                  if count > 0:
                      print(f"  {sev}: {count}")

              # Set environment variables
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"VULN_TOTAL={len(matches)}\n")
                  f.write(f"VULN_CRITICAL={severity_counts['Critical']}\n")
                  f.write(f"VULN_HIGH={severity_counts['High']}\n")

          except Exception as e:
              print(f"Error parsing Grype results: {e}")
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write("VULN_TOTAL=0\n")
                  f.write("VULN_CRITICAL=0\n")
                  f.write("VULN_HIGH=0\n")
          EOF

      - name: Analyze licenses
        env:
          DENY_LICENSES: ${{ inputs.deny_licenses }}
        run: |
          echo "Analyzing component licenses..."

          python3 << 'EOF'
          import json
          import os
          import re

          # Load SBOM
          data = json.load(open('sbom.cyclonedx.json'))
          components = data.get('components', [])

          # Parse denied licenses from env
          deny_licenses_raw = os.environ.get('DENY_LICENSES', '')
          deny_licenses = [l.strip().lower() for l in deny_licenses_raw.split(',') if l.strip()]

          # Common copyleft licenses (restrictive for proprietary use)
          COPYLEFT_LICENSES = [
              'gpl', 'agpl', 'lgpl', 'cc-by-sa', 'mpl', 'cddl', 'epl',
              'osl', 'eupl', 'cecill'
          ]

          # Permissive licenses (generally safe)
          PERMISSIVE_LICENSES = [
              'mit', 'apache', 'bsd', 'isc', 'unlicense', 'cc0', 'wtfpl',
              'zlib', 'boost', 'public domain', '0bsd'
          ]

          license_summary = {
              'permissive': [],
              'copyleft': [],
              'denied': [],
              'unknown': []
          }

          problems = []

          for comp in components:
              name = comp.get('name', 'unknown')
              version = comp.get('version', '?')
              licenses = comp.get('licenses', [])

              if not licenses:
                  license_summary['unknown'].append(f"{name}@{version}")
                  continue

              for lic in licenses:
                  # Handle different license formats in CycloneDX
                  if isinstance(lic, dict):
                      lic_id = lic.get('license', {}).get('id', '') or lic.get('license', {}).get('name', '')
                      lic_expression = lic.get('expression', '')
                      lic_str = lic_id or lic_expression
                  else:
                      lic_str = str(lic)

                  lic_lower = lic_str.lower()

                  # Check if denied
                  if any(d in lic_lower for d in deny_licenses):
                      license_summary['denied'].append(f"{name}@{version} ({lic_str})")
                      problems.append({
                          'type': 'denied_license',
                          'component': name,
                          'version': version,
                          'license': lic_str
                      })
                  # Check if copyleft
                  elif any(c in lic_lower for c in COPYLEFT_LICENSES):
                      license_summary['copyleft'].append(f"{name}@{version} ({lic_str})")
                      # Only flag as problem if not explicitly allowed
                      if 'lgpl' not in lic_lower:  # LGPL is often acceptable
                          problems.append({
                              'type': 'copyleft_license',
                              'component': name,
                              'version': version,
                              'license': lic_str
                          })
                  # Check if permissive
                  elif any(p in lic_lower for p in PERMISSIVE_LICENSES):
                      license_summary['permissive'].append(f"{name}@{version}")
                  else:
                      license_summary['unknown'].append(f"{name}@{version} ({lic_str})")

          # Print summary
          print("License Summary:")
          print(f"  Permissive: {len(license_summary['permissive'])}")
          print(f"  Copyleft: {len(license_summary['copyleft'])}")
          print(f"  Denied: {len(license_summary['denied'])}")
          print(f"  Unknown: {len(license_summary['unknown'])}")

          # Save results
          with open('license-analysis.json', 'w') as f:
              json.dump({
                  'summary': {k: len(v) for k, v in license_summary.items()},
                  'details': license_summary,
                  'problems': problems
              }, f, indent=2)

          # Set env vars
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"LICENSE_PROBLEMS={len(problems)}\n")
              f.write(f"LICENSE_DENIED={len(license_summary['denied'])}\n")
              f.write(f"LICENSE_COPYLEFT={len(license_summary['copyleft'])}\n")
              f.write(f"LICENSE_UNKNOWN={len(license_summary['unknown'])}\n")

          EOF

      - name: Generate comprehensive report
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime

          # Load all data
          sbom = json.load(open('sbom.cyclonedx.json'))
          grype = json.load(open('grype-results.json')) if os.path.exists('grype-results.json') else {'matches': []}
          licenses = json.load(open('license-analysis.json'))

          components = sbom.get('components', [])
          vulnerabilities = grype.get('matches', [])

          report = []
          report.append("# SBOM & License Compliance Report")
          report.append(f"\nGenerated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}")
          report.append(f"Repository: {os.environ.get('GITHUB_REPOSITORY', 'unknown')}")
          report.append("")

          # Summary table
          report.append("## Summary")
          report.append("")
          report.append("| Metric | Count |")
          report.append("|--------|-------|")
          report.append(f"| Total Components | {len(components)} |")
          report.append(f"| Vulnerabilities | {len(vulnerabilities)} |")
          report.append(f"| Critical/High CVEs | {os.environ.get('VULN_CRITICAL', 0)}/{os.environ.get('VULN_HIGH', 0)} |")
          report.append(f"| License Issues | {licenses['summary'].get('denied', 0) + licenses['summary'].get('copyleft', 0)} |")
          report.append(f"| Unknown Licenses | {licenses['summary'].get('unknown', 0)} |")
          report.append("")

          # Vulnerabilities section
          if vulnerabilities:
              report.append("## Vulnerabilities")
              report.append("")

              # Group by severity
              by_severity = {}
              for v in vulnerabilities:
                  sev = v.get('vulnerability', {}).get('severity', 'Unknown')
                  if sev not in by_severity:
                      by_severity[sev] = []
                  by_severity[sev].append(v)

              for sev in ['Critical', 'High', 'Medium', 'Low']:
                  if sev in by_severity:
                      report.append(f"### {sev} ({len(by_severity[sev])})")
                      report.append("")
                      report.append("| Package | Version | CVE | Fix Available |")
                      report.append("|---------|---------|-----|---------------|")

                      for v in by_severity[sev][:10]:
                          vuln = v.get('vulnerability', {})
                          artifact = v.get('artifact', {})
                          pkg = artifact.get('name', 'unknown')
                          ver = artifact.get('version', '?')
                          cve = vuln.get('id', 'N/A')
                          fix = vuln.get('fix', {}).get('versions', [])
                          fix_str = fix[0] if fix else 'No'

                          report.append(f"| {pkg} | {ver} | {cve} | {fix_str} |")

                      if len(by_severity[sev]) > 10:
                          report.append(f"\n*... and {len(by_severity[sev]) - 10} more {sev.lower()} vulnerabilities*")
                      report.append("")

          # License issues section
          if licenses['problems']:
              report.append("## License Issues")
              report.append("")

              denied = [p for p in licenses['problems'] if p['type'] == 'denied_license']
              copyleft = [p for p in licenses['problems'] if p['type'] == 'copyleft_license']

              if denied:
                  report.append("### Denied Licenses")
                  report.append("")
                  report.append("These components use licenses that are explicitly denied:")
                  report.append("")
                  for p in denied[:10]:
                      report.append(f"- **{p['component']}@{p['version']}**: {p['license']}")
                  report.append("")

              if copyleft:
                  report.append("### Copyleft Licenses (Review Required)")
                  report.append("")
                  report.append("These components use copyleft licenses that may have restrictions:")
                  report.append("")
                  for p in copyleft[:10]:
                      report.append(f"- **{p['component']}@{p['version']}**: {p['license']}")
                  report.append("")

          # Unknown licenses
          if licenses['details'].get('unknown'):
              report.append("## Unknown Licenses")
              report.append("")
              report.append("These components have unrecognized or missing license information:")
              report.append("")
              for comp in licenses['details']['unknown'][:15]:
                  report.append(f"- {comp}")
              if len(licenses['details']['unknown']) > 15:
                  report.append(f"\n*... and {len(licenses['details']['unknown']) - 15} more*")
              report.append("")

          # Top dependencies
          report.append("## Top Dependencies by Type")
          report.append("")

          # Group by type
          by_type = {}
          for c in components:
              ctype = c.get('type', 'unknown')
              if ctype not in by_type:
                  by_type[ctype] = []
              by_type[ctype].append(c)

          for ctype, comps in sorted(by_type.items(), key=lambda x: -len(x[1]))[:5]:
              report.append(f"- **{ctype}**: {len(comps)} components")
          report.append("")

          # Write report
          with open('sbom-report.md', 'w') as f:
              f.write('\n'.join(report))

          print("Report generated: sbom-report.md")
          EOF

      - name: Check AI API key
        id: check-ai
        env:
          AI_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          if [ -n "$AI_KEY" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Analysis (optional)
        if: (env.VULN_TOTAL != '0' || env.LICENSE_PROBLEMS != '0') && steps.check-ai.outputs.has_key == 'true'
        continue-on-error: true
        env:
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          pip install git+https://github.com/savorywatt/repo-sapiens.git@v2

          sapiens task "Analyze this SBOM and security report for a software project.

          $(cat sbom-report.md)

          License Analysis Details:
          $(cat license-analysis.json)

          Tasks:
          1. Prioritize the vulnerabilities by actual risk (considering exploitability, not just severity)
          2. For license issues, explain the specific compliance risks
          3. Recommend which dependencies should be updated or replaced
          4. Identify any patterns (e.g., outdated ecosystem, too many transitive deps)
          5. Write a concise executive summary (3-5 bullet points) for the maintainers

          Output your analysis to 'ai-analysis.md' using the write_file tool.

          Be practical - focus on actionable recommendations, not theoretical risks."

      - name: Create issue for critical findings
        if: (env.VULN_CRITICAL != '0' || env.VULN_HIGH != '0' || env.LICENSE_DENIED != '0') && inputs.create_issues
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          gh issue create \
            --title "SBOM Alert: $(date +%Y-%m-%d) - ${{ env.VULN_CRITICAL }} critical, ${{ env.LICENSE_DENIED }} license issues" \
            --body "## SBOM & License Compliance Alert

          The SBOM scan has identified issues requiring attention.

          ### Summary
          - **Critical Vulnerabilities**: ${{ env.VULN_CRITICAL }}
          - **High Vulnerabilities**: ${{ env.VULN_HIGH }}
          - **Denied Licenses**: ${{ env.LICENSE_DENIED }}
          - **Total Components**: ${{ env.COMPONENT_COUNT }}

          ### Full Report
          See the workflow artifacts for:
          - \`sbom-report.md\` - Full analysis report
          - \`sbom.cyclonedx.json\` - SBOM in CycloneDX format
          - \`sbom.spdx.json\` - SBOM in SPDX format
          - \`grype-results.json\` - Vulnerability scan results
          - \`license-analysis.json\` - License compliance details

          ### Recommended Actions
          1. Review critical and high vulnerabilities for exploitability
          2. Update affected dependencies to patched versions
          3. Review license conflicts for compliance requirements
          4. Consider replacing components with denied licenses

          ---
          *Generated by repo-sapiens SBOM workflow*" \
            --label "security" --label "dependencies" --label "automated" || echo "Issue creation failed"

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_number }}
          path: |
            sbom.cyclonedx.json
            sbom.spdx.json
            sbom.syft.json
            grype-results.json
            license-analysis.json
            sbom-report.md
            ai-analysis.md
          retention-days: 90

      - name: Commit SBOM to repository (optional)
        if: always()
        continue-on-error: true
        run: |
          mkdir -p .sbom
          cp sbom.cyclonedx.json .sbom/
          cp sbom.spdx.json .sbom/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .sbom/
          if ! git diff --staged --quiet; then
            git commit -m "chore: Update SBOM $(date +%Y-%m-%d)

          Components: ${{ env.COMPONENT_COUNT }}
          Vulnerabilities: ${{ env.VULN_TOTAL }}

          [skip ci]"
            git push || echo "Push failed - may need write permissions"
          fi

      - name: Fail on critical vulnerabilities
        if: inputs.fail_on_vulnerabilities
        run: |
          if [ "${{ env.VULN_CRITICAL }}" != "0" ] || [ "${{ env.VULN_HIGH }}" != "0" ]; then
            echo "Critical or high vulnerabilities found!"
            echo "Critical: ${{ env.VULN_CRITICAL }}"
            echo "High: ${{ env.VULN_HIGH }}"
            exit 1
          fi

      - name: Add to job summary
        run: cat sbom-report.md >> $GITHUB_STEP_SUMMARY
