# .github/workflows/sapiens-issue-triage.yaml
# Reusable workflow for issue triage
name: "Sapiens Issue Triage"

on:
  workflow_call:
    inputs:
      auto_label:
        description: 'Automatically add labels to issues'
        required: false
        type: boolean
        default: true
      labels_config:
        description: 'JSON config for label mapping (optional)'
        required: false
        type: string
        default: ''
    secrets:
      GIT_TOKEN:
        description: 'GitHub token for API access'
        required: true
      AI_API_KEY:
        description: 'AI provider API key for analysis'
        required: false

permissions:
  issues: write
  contents: read

jobs:
  triage-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install repo-sapiens
        run: pip install repo-sapiens==0.5.0

      - name: Get untriaged issues
        id: issues
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          # Get issues without standard labels
          gh issue list --state open --json number,title,labels,createdAt \
            --jq '[.[] | select(.labels | length == 0 or all(.name != "bug" and .name != "enhancement" and .name != "question"))]' \
            > untriaged.json

          COUNT=$(cat untriaged.json | jq 'length')
          echo "untriaged_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT untriaged issues"

      - name: Check AI API key
        id: check-ai
        env:
          AI_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          if [ -n "$AI_KEY" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "::notice::AI_API_KEY not provided - skipping AI-powered triage"
          fi

      - name: Triage issues
        if: steps.issues.outputs.untriaged_count != '0' && steps.check-ai.outputs.has_key == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
          AUTOMATION__GIT_PROVIDER__API_TOKEN: ${{ secrets.GIT_TOKEN }}
          AUTOMATION__AGENT_PROVIDER__API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          sapiens task "Triage open issues in this GitHub repository.

          Repository: ${{ github.repository }}
          Untriaged issues: $(cat untriaged.json)

          Tasks:
          1. For each issue in the list above:
             a. Read the issue title and check its content via: gh issue view <number>
             b. Categorize: bug, enhancement, question, or documentation
             c. Assess priority: low, medium, high (based on impact and urgency)
             d. Add labels via: gh issue edit <number> --add-label <label>
             e. If high priority, add a comment noting it needs attention

          Commands to use:
          - View issue: gh issue view <number>
          - Add label: gh issue edit <number> --add-label bug
          - Add comment: gh issue comment <number> --body 'message'

          Label mapping:
          - Bug reports → 'bug' label
          - Feature requests → 'enhancement' label
          - Questions → 'question' label
          - Security issues → 'priority-high' + 'security' labels

          Guidelines:
          - Be helpful and welcoming in any comments
          - Don't close issues automatically
          - Flag unclear issues with 'needs-info' label
          - Note if issue appears to be a duplicate"

      - name: Summary
        run: |
          echo "## Issue Triage Summary" >> $GITHUB_STEP_SUMMARY
          echo "Processed ${{ steps.issues.outputs.untriaged_count }} untriaged issues" >> $GITHUB_STEP_SUMMARY
