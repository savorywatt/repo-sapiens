# `repo-agent init` Command Guide

Complete guide to using the `repo-agent init` command for automated repository setup.

## Overview

The `init` command provides a streamlined, interactive way to set up repo-agent in your Git repository. It handles:

1. **Repository Discovery**: Auto-detects Git configuration
2. **Credential Management**: Securely stores API tokens
3. **Configuration Generation**: Creates automation_config.yaml
4. **Gitea Actions Setup**: Guides you through setting up repository secrets

## Quick Start

```bash
# Navigate to your Git repository
cd /path/to/your/repo

# Run init (interactive)
repo-agent init
```

## What Happens During Init

### 1. Repository Discovery

The command automatically detects:
- Git remote URL (origin, upstream, or first available)
- Repository owner and name
- Gitea base URL
- Remote type (SSH or HTTPS)

Example output:
```
üîç Discovering repository configuration...
   ‚úì Found Git repository: /home/user/my-project
   ‚úì Detected remote: origin
   ‚úì Parsed: owner=myuser, repo=my-project
   ‚úì Base URL: https://gitea.example.com
```

### 2. Credential Collection

**Interactive Mode** (default):
```
üîë Setting up credentials...

Gitea API Token is required. Get it from:
   https://gitea.example.com/user/settings/applications

Enter your Gitea API token: ‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè

Do you want to use Claude API or local Claude Code? [local/api]: local
```

**Non-Interactive Mode** (CI/CD):
```bash
export GITEA_TOKEN="your-token-here"
export CLAUDE_API_KEY="your-key-here"  # optional
repo-agent init --non-interactive
```

### 3. Credential Storage

Credentials are stored based on your environment:

**Workstation** (default: keyring):
```
üì¶ Storing credentials in keyring backend...
   ‚úì Stored: gitea/api_token
   ‚úì Credentials stored securely
```

**CI/CD** (environment variables):
```bash
repo-agent init --backend environment
```

**Headless Server** (encrypted file):
```bash
export BUILDER_MASTER_PASSWORD="secure-password"
repo-agent init --backend encrypted
```

### 4. Gitea Actions Secrets

The command guides you through setting up repository secrets for Gitea Actions:

```
üîê Setting up Gitea Actions secrets...
   ‚Ñπ Please set GITEA_TOKEN manually in Gitea UI for now
   Navigate to: https://gitea.example.com/myuser/my-project/settings/secrets
```

**What secrets to set**:
- `GITEA_TOKEN`: Your Gitea API token (required)
- `CLAUDE_API_KEY`: Your Claude API key (only if using API mode)

**How to set them**:

1. Navigate to your repository settings:
   ```
   https://gitea.example.com/<owner>/<repo>/settings/secrets
   ```

2. Click "Add Secret"

3. Add `GITEA_TOKEN`:
   - Name: `GITEA_TOKEN`
   - Value: (paste your Gitea API token)
   - Click "Add Secret"

4. Add `CLAUDE_API_KEY` (if using API mode):
   - Name: `CLAUDE_API_KEY`
   - Value: (paste your Claude API key)
   - Click "Add Secret"

**Why these secrets are needed**:

Gitea Actions workflows need these secrets to:
- Access the Gitea API to read issues, create PRs, etc. (`GITEA_TOKEN`)
- Call the Claude API for AI-powered code generation (`CLAUDE_API_KEY`)

The secrets are stored securely in Gitea and are only accessible to workflow runs.

### 5. Configuration File Generation

A `automation_config.yaml` file is created:

```yaml
# Automation System Configuration
# Generated by: repo-agent init
# Repository: myuser/my-project

git_provider:
  provider_type: gitea
  mcp_server: gitea-mcp
  base_url: https://gitea.example.com
  api_token: @keyring:gitea/api_token  # Secure reference

repository:
  owner: myuser
  name: my-project
  default_branch: main

agent_provider:
  provider_type: claude-local  # or claude-api
  model: claude-sonnet-4.5
  api_key: null  # or @keyring:claude/api_key
  local_mode: true

workflow:
  plans_directory: plans
  state_directory: .automation/state
  branching_strategy: per-agent
  max_concurrent_tasks: 3
  review_approval_threshold: 0.8

tags:
  needs_planning: needs-planning
  plan_review: plan-review
  ready_to_implement: ready-to-implement
  in_progress: in-progress
  code_review: code-review
  merge_ready: merge-ready
  completed: completed
  needs_attention: needs-attention
```

### 6. Validation

The command validates that everything is set up correctly:

```
‚úì Validating setup...
   ‚úì Credentials validated
   ‚úì Configuration file created

‚úÖ Initialization complete!
```

## Command Options

### Basic Options

```bash
repo-agent init [OPTIONS]
```

**`--repo-path DIRECTORY`**
- Path to Git repository
- Default: current directory
- Example: `repo-agent init --repo-path /path/to/repo`

**`--config-path PATH`**
- Where to save configuration file
- Default: `automation/config/automation_config.yaml`
- Example: `repo-agent init --config-path config/my_config.yaml`

**`--backend [keyring|environment|encrypted]`**
- Credential storage backend
- Auto-detected if not specified
- Example: `repo-agent init --backend keyring`

**`--non-interactive`**
- Skip interactive prompts
- Requires `GITEA_TOKEN` and optionally `CLAUDE_API_KEY` env vars
- Example: `repo-agent init --non-interactive`

**`--setup-secrets` / `--no-setup-secrets`**
- Whether to set up Gitea Actions secrets
- Default: true
- Example: `repo-agent init --no-setup-secrets`

## Usage Examples

### Example 1: Standard Interactive Setup

```bash
cd my-repo
repo-agent init
```

Output:
```
üöÄ Initializing repo-agent

üîç Discovering repository configuration...
   ‚úì Found Git repository: /home/user/my-repo
   ‚úì Detected remote: origin
   ‚úì Parsed: owner=myuser, repo=my-repo
   ‚úì Base URL: https://gitea.example.com

üîë Setting up credentials...

Gitea API Token is required. Get it from:
   https://gitea.example.com/user/settings/applications

Enter your Gitea API token: ‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè

Do you want to use Claude API or local Claude Code? [local/api]: local

üì¶ Storing credentials in keyring backend...
   ‚úì Stored: gitea/api_token
   ‚úì Credentials stored securely

üîê Setting up Gitea Actions secrets...
   ‚Ñπ Please set GITEA_TOKEN manually in Gitea UI for now
   Navigate to: https://gitea.example.com/myuser/my-repo/settings/secrets

üìù Creating configuration file...
   ‚úì Created: automation/config/automation_config.yaml

‚úì Validating setup...
   ‚úì Credentials validated
   ‚úì Configuration file created

‚úÖ Initialization complete!

üìã Next Steps:

1. Label an issue with 'needs-planning' in Gitea:
   https://gitea.example.com/myuser/my-repo/issues

2. Run the automation daemon:
   repo-agent --config automation/config/automation_config.yaml daemon --interval 60

3. Watch the automation work!
```

### Example 2: CI/CD Non-Interactive Setup

```bash
# In your CI/CD pipeline
export GITEA_TOKEN="${SECRETS_GITEA_TOKEN}"
export CLAUDE_API_KEY="${SECRETS_CLAUDE_API_KEY}"

repo-agent init --non-interactive --backend environment
```

### Example 3: Custom Config Location

```bash
repo-agent init --config-path config/production.yaml
```

### Example 4: Skip Gitea Secrets Setup

```bash
# If you want to set up secrets manually later
repo-agent init --no-setup-secrets
```

### Example 5: Force Keyring Backend

```bash
# Explicitly use keyring even if environment would work
repo-agent init --backend keyring
```

## Gitea Actions Secrets Setup (Detailed)

### Why Secrets Are Needed

Gitea Actions workflows run in isolated environments and need credentials to:

1. **Access Gitea API** (`GITEA_TOKEN`):
   - Read issues and comments
   - Create branches and pull requests
   - Update issue labels and status
   - Post automation results

2. **Access Claude API** (`CLAUDE_API_KEY`):
   - Generate development plans
   - Implement code changes
   - Review pull requests
   - Only needed if using `claude-api` mode

### Local vs CI/CD Credentials

**Local Development**:
- Credentials stored in OS keyring or encrypted file
- Used when you run `repo-agent` commands locally
- Never committed to Git

**CI/CD (Gitea Actions)**:
- Credentials stored as Gitea repository secrets
- Injected as environment variables during workflow runs
- Accessible only to workflow runs, not to code

### Setting Secrets in Gitea

**Step-by-step**:

1. **Navigate to Repository Settings**:
   ```
   https://gitea.example.com/<your-org>/<your-repo>/settings/secrets
   ```

2. **Add GITEA_TOKEN Secret**:
   - Click "Add Secret"
   - Name: `GITEA_TOKEN`
   - Value: Your Gitea API token from https://gitea.example.com/user/settings/applications
   - Click "Add Secret"

3. **Add CLAUDE_API_KEY Secret** (if using API mode):
   - Click "Add Secret"
   - Name: `CLAUDE_API_KEY`
   - Value: Your Claude API key from https://console.anthropic.com/
   - Click "Add Secret"

4. **Verify Secrets**:
   - You should see both secrets listed
   - Values are hidden (only show `*****`)
   - Secrets are available to all workflows in the repository

### Using Secrets in Workflows

Gitea Actions workflows access secrets via `${{ secrets.SECRET_NAME }}`:

```yaml
# .gitea/workflows/automation-daemon.yaml
name: Automation Daemon

on:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install repo-agent
        run: pip install repo-agent

      - name: Process Issues
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          repo-agent --config automation/config/automation_config.yaml process-all
```

The workflow uses environment variable references in the config:

```yaml
# automation/config/automation_config.yaml
git_provider:
  api_token: ${GITEA_TOKEN}  # Resolved from env var

agent_provider:
  api_key: ${CLAUDE_API_KEY}  # Resolved from env var
```

## Troubleshooting

### Error: Not a Git repository

```
Error: /path/to/dir is not a Git repository
```

**Solution**: Navigate to a directory with a `.git` folder or initialize Git:
```bash
cd /path/to/your/repo
# or
git init
git remote add origin git@gitea.example.com:owner/repo.git
```

### Error: No remotes configured

```
Error: No Git remotes found
```

**Solution**: Add a Git remote:
```bash
git remote add origin https://gitea.example.com/owner/repo.git
```

### Error: Keyring backend not available

```
Keyring backend: Not available
  Install with: pip install keyring
```

**Solution**: Install keyring or use environment backend:
```bash
pip install keyring
# or
repo-agent init --backend environment
```

### Error: Failed to parse repository URL

```
Error: Failed to parse repository URL
```

**Solution**: Ensure your remote URL is valid:
```bash
# Check current remote
git remote -v

# Update if needed
git remote set-url origin git@gitea.example.com:owner/repo.git
```

### Credential Not Resolved

**Symptom**: Configuration file exists but credentials fail to resolve.

**Solution**: Verify credentials are stored:
```bash
# Test credential resolution
repo-agent credentials get @keyring:gitea/api_token

# Re-store if needed
repo-agent credentials set gitea/api_token --backend keyring
```

## Advanced Usage

### Custom Encrypted Backend Password

```bash
export BUILDER_MASTER_PASSWORD="my-secure-password"
repo-agent init --backend encrypted
```

### Multiple Repositories

Run `init` in each repository directory:

```bash
cd ~/projects/repo1
repo-agent init --config-path config/repo1.yaml

cd ~/projects/repo2
repo-agent init --config-path config/repo2.yaml
```

### Organization-Level Setup

For multiple repositories in the same organization:

```bash
# First repo (interactive)
cd ~/org/repo1
repo-agent init

# Subsequent repos (reuse credentials)
cd ~/org/repo2
repo-agent init  # Uses same keyring credentials

cd ~/org/repo3
repo-agent init  # Uses same keyring credentials
```

## Next Steps After Init

1. **Label an issue** with `needs-planning`:
   ```
   https://gitea.example.com/<owner>/<repo>/issues
   ```

2. **Run the daemon**:
   ```bash
   repo-agent daemon --interval 60
   ```

3. **Monitor progress**:
   ```bash
   repo-agent list-plans
   repo-agent show-plan --plan-id <id>
   ```

4. **Set up Gitea Actions workflows** (optional):
   - Copy example workflows from `.gitea/workflows/`
   - Customize as needed
   - Commit and push to repository

## Related Documentation

- [QUICK_START.md](../QUICK_START.md) - Quick setup guide
- [CREDENTIAL_QUICK_START.md](CREDENTIAL_QUICK_START.md) - Credential management
- [CI_CD_GUIDE.md](../CI_CD_GUIDE.md) - CI/CD integration
- [README.md](../README.md) - Full documentation

## Getting Help

```bash
# View init command help
repo-agent init --help

# View credentials help
repo-agent credentials --help

# General help
repo-agent --help
```

For issues or questions:
- GitHub Issues: https://github.com/shireadmin/repo-agent/issues
- Documentation: Check the `docs/` directory
