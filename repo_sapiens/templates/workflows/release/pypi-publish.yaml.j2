{% import 'workflows/base.yaml.j2' as base %}

name: {{ workflow_name | default('Publish to PyPI') | safe_label }}

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test-pypi:
        description: 'Publish to Test PyPI instead of PyPI'
        required: false
        default: 'false'
        type: boolean

{{ base.git_env_vars(provider_type | default('gitea'), git_url, git_owner, git_repo) }}

jobs:
  publish:
    name: Build and Publish
    runs-on: {{ runner | default('ubuntu-latest') | safe_identifier }}

    environment:
      name: {{ environment | default('release') | safe_identifier }}
      url: https://pypi.org/project/{{ package_name | safe_identifier }}/

    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    steps:
      {{ base.checkout_step(fetch_depth=0) }}

      {{ base.setup_python_step(version=python_version | default('3.11')) }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip build twine

      - name: Verify version matches tag
        if: github.event_name == 'release'
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION=$(python -c "import {{ package_name | safe_identifier }}; print({{ package_name | safe_identifier }}.__version__)")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Version mismatch: tag=$TAG_VERSION package=$PKG_VERSION"
            exit 1
          fi

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      {% if use_trusted_publishing | default(true) -%}
      - name: Publish to PyPI (trusted publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: ${{ '{{' }} inputs.test-pypi == 'true' && 'https://test.pypi.org/legacy/' || 'https://upload.pypi.org/legacy/' {{ '}}' }}
      {%- else -%}
      - name: Publish to PyPI (API token)
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ '{{' }} secrets.PYPI_API_TOKEN {{ '}}' }}
        run: |
          {% if test_pypi | default(false) -%}
          twine upload --repository testpypi dist/*
          {%- else -%}
          twine upload dist/*
          {%- endif %}
      {%- endif %}

      - name: Create GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
